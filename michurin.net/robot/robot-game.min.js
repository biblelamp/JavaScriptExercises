document.addEventListener("DOMContentLoaded", function () {
    var a = function (a) {
        function b(a, b, c, d, e) {
            a.beginPath(), a.arc(b, c, d, 0, 2 * Math.PI, !1);
            var f = a.createRadialGradient(b - d / 4, c - d / 4, 2, b, c, d);
            f.addColorStop(0, "#fff"), f.addColorStop(1, e), a.fillStyle = f, a.fill()
        }

        var c = a.getContext("2d"), d = {}, e = 20, f = function () {
            function a(a, c, d) {
                var f = document.createElement("canvas"), g = e + 2;
                f.width = 2 * g, f.height = 2 * g;
                var h = f.getContext("2d"), i = 0, j = (a - 1) * e - 2,
                    k = (c - 1) * e - 2;
                return {
                    tik: function (a, c) {
                        i += .05;
                        var l, m = i >= 1;
                        return l = m ? e : e * i, h.clearRect(0, 0, f.width, f.height), b(h, g, g, l, d), m && c.drawImage(f, j, k), a.drawImage(f, j, k), m
                    }
                }
            }

            function c(a, c, d) {
                var f = document.createElement("canvas"), g = 3 * e + 2;
                f.width = 2 * g, f.height = 2 * g;
                var h, i, j, k = f.getContext("2d"), l = 0, m = [],
                    n = Math.floor(4 * Math.random() + 10), o = Math.sqrt(e);
                for (h = 0; n > h; ++h) i = 2 * Math.PI * Math.random(), j = o * Math.random(), j *= j, m.push({
                    x: j * Math.cos(i),
                    y: j * Math.sin(i),
                    r: e * (.2 * Math.random() + .3),
                    c: .5 * Math.random() + .5
                });
                var p = (a - 3) * e - 2, q = (c - 3) * e - 2;
                return {
                    tik: function (a) {
                        l += .03, k.clearRect(0, 0, f.width, f.height);
                        var c, e, h, i = m.length;
                        for (c = 0, h = 0; i > c; ++c) e = m[c], l < e.c && (h++, b(k, g + e.x * (1 + l), g + e.y * (1 + l), e.r, d));
                        return 0 === h ? !0 : (a.drawImage(f, p, q), !1)
                    }
                }
            }

            function d(a, b) {
                return a + ":" + b
            }

            function f() {
                i.beginPath(), i.rect(0, 0, h.width, h.height), i.fillStyle = "#000", i.fill();
                var a;
                for (a in j) if (j.hasOwnProperty(a)) {
                    var c = a.split(":");
                    b(i, e * parseFloat(c[0]), e * parseFloat(c[1]), e, j[a])
                }
            }

            function g(a, b) {
                var e = d(a, b), g = e + "_del";
                void 0 !== j[e] && (k[g] = c(a, b, j[e]), delete j[e], f())
            }

            var h = document.createElement("canvas"), i = h.getContext("2d"),
                j = {}, k = {};
            return {
                resize: function (a, b) {
                    h.width = a, h.height = b, f()
                }, put: function (b, c, e) {
                    var f, h, i = d(b, c);
                    for (f = b - 1; b + 1 >= f; ++f) for (h = c - 1; c + 1 >= h; ++h) g(f, h);
                    j[i] = e, k[i] = a(b, c, e)
                }, clean: g, tik: function (a) {
                    a.drawImage(h, 0, 0);
                    var b, c;
                    for (b in k) k.hasOwnProperty(b) && (c = k[b].tik(a, i), c && delete k[b])
                }
            }
        }(), g = function () {
            function a(a, c, d) {
                m.save(), m.rotate(Math.PI * a), m.beginPath(), m.moveTo(l, 0), m.lineTo(1.4 * l, .3 * l * c), m.lineTo(1.8 * l, 0), m.stroke(), void 0 !== d && (m.translate(1.9 * l, -.5 * l), m.rotate(-d - Math.PI * a), b(m, 0, 0, .4 * l, F)), m.restore()
            }

            function c(a, b, c) {
                m.save(), m.rotate(a), m.translate(0, l), m.rotate(b), m.beginPath(), m.moveTo(0, 0), m.lineTo(0, l * c), m.stroke(), m.restore()
            }

            function d(a) {
                var b;
                Math.random() < .04 || (m.save(), m.rotate(a), m.beginPath(), E ? (b = .2, m.strokeStyle = "#fff") : b = .05, m.arc(-.2 * l * (1 + b), l * (.8 - b), l * b, 0, 2 * Math.PI, !1), m.stroke(), m.beginPath(), m.arc(.2 * l * (1 + b), l * (.8 - b), l * b, 0, 2 * Math.PI, !1), m.stroke(), m.restore())
            }

            function g() {
                var a;
                a = r ? (v + 8) % 16 : v, q && (a += 16);
                var b = u[a], c = y - b.dx, d = z + b.dy;
                return 0 >= c || 0 >= d || c > o || d > p ? {dx: 0, dy: 0} : b
            }

            function h(a, b) {
                q = a, r = b, s = .1
            }

            function i() {
                if (void 0 === n && void 0 === s) {
                    var a = C.shift();
                    if (void 0 === a) return;
                    if ("number" == typeof a) {
                        var b;
                        for (b = 0; a > b; ++b) C = C.concat(D);
                        return E = !1, i(), void 0
                    }
                    if ("record" === a) return E = !0, D = [], void 0;
                    E || (D = []), D.push(a), "left" === a ? (n = .1, w = (v + 2) % 16) : "right" === a ? (n = .1, w = (v + 14) % 16) : "left_short" === a ? (n = .1, w = (v + 1) % 16) : "right_short" === a ? (n = .1, w = (v + 15) % 16) : "run" === a ? h(!1, !1) : "run_short" === a ? h(!0, !1) : "back" === a ? h(!1, !0) : "back_short" === a ? h(!0, !0) : "put" === a ? (f.put(y, z, F), h(!1, !1)) : "clean" === a ? (f.clean(y, z), h(!1, !1)) : "#" === a.charAt(0) && (F = a, i())
                }
            }

            function j() {
                v = 0, w = 0, n = void 0, x = 0, y = 5, z = 5, A = y, B = z, s = void 0, C = [], D = []
            }

            var k = document.createElement("canvas"), l = e;
            k.width = 6 * l, k.height = 6 * l;
            var m = k.getContext("2d");
            m.lineWidth = 2, m.strokeStyle = "#cccccc";
            var n, o, p, q, r, s, t = 0,
                u = [{dx: 0, dy: 2}, {dx: -1, dy: 2}, {dx: -2, dy: 2}, {
                    dx: -2,
                    dy: 1
                }, {dx: -2, dy: 0}, {dx: -2, dy: -1}, {dx: -2, dy: -2}, {
                    dx: -1,
                    dy: -2
                }, {dx: 0, dy: -2}, {dx: 1, dy: -2}, {dx: 2, dy: -2}, {
                    dx: 2,
                    dy: -1
                }, {dx: 2, dy: 0}, {dx: 2, dy: 1}, {dx: 2, dy: 2}, {
                    dx: 1,
                    dy: 2
                }, {dx: 0, dy: 1}, {dx: -1, dy: 2}, {dx: -1, dy: 1}, {
                    dx: -2,
                    dy: 1
                }, {dx: -1, dy: 0}, {dx: -2, dy: -1}, {dx: -1, dy: -1}, {
                    dx: -1,
                    dy: -2
                }, {dx: 0, dy: -1}, {dx: 1, dy: -2}, {dx: 1, dy: -1}, {
                    dx: 2,
                    dy: -1
                }, {dx: 1, dy: 0}, {dx: 2, dy: 1}, {dx: 1, dy: 1}, {
                    dx: 1,
                    dy: 2
                }], v = 0, w = 0, x = 0, y = 1, z = 1, A = y, B = z, C = [],
                D = [], E = !1, F = "#0f0";
            return j(), {
                tik: function (b) {
                    m.clearRect(0, 0, k.width, k.height), m.save(), m.translate(3 * l, 3 * l), m.beginPath(), m.arc(0, 0, l, 0, 2 * Math.PI, !1), m.stroke();
                    var e, f, h;
                    void 0 !== n ? n > 1 ? (e = 0, f = 0, n = void 0, v = w, x = Math.atan2(u[v].dx, u[v].dy), i()) : (x = Math.atan2(u[v].dx * (1 - n) + u[w].dx * n, u[v].dy * (1 - n) + u[w].dy * n), e = .07 * Math.sin(Math.PI * n), f = 5 * e, n += .1) : void 0 !== s ? (h = g(), s >= 1 ? (e = 0, f = 0, s = void 0, y -= h.dx, z += h.dy, A = y, B = z, i()) : (A = y - h.dx * s, B = z + h.dy * s, e = .07 * Math.sin(2 * Math.PI * s), f = 5 * e, s += .1)) : (e = 0, f = 0), m.rotate(x), a(-.2 - e, -1 + f), a(e, -1 - f), a(.2 - e, -1 + f), a(.8 + e, 1 - f, x), a(1 - e, 1 + f), a(1.2 + e, 1 - f), t += .1;
                    var j = .09 * Math.sin(.53 * t),
                        o = .09 * Math.sin(.63 * t), p = (j + o) / 2,
                        q = (12 + Math.sin(.73 * t)) / 8;
                    c(p + .2, j, q), c(p - .2, o, q), d(p), m.restore(), b.drawImage(k, (A - 3) * l, (B - 3) * l)
                }, task: function (a) {
                    C[C.length - 1] !== a && (C.push(a), i())
                }, resize: function (a, b) {
                    o = Math.floor(a / e), p = Math.floor(b / e)
                }, reset: j
            }
        }();
        return d.tik = function () {
            c.clearRect(0, 0, a.width, a.height), f.tik(c), g.tik(c)
        }, d.reinit = function () {
            var b = window.innerWidth, c = window.innerHeight, d = a.width,
                e = a.height;
            (b !== d || c !== e) && (a.width = b, a.height = c, f.resize(b, c), g.resize(b, c), d = b, e = c)
        }, d.task = g.task, d.reset = g.reset, d.set = g.set, d
    }(document.getElementsByTagName("canvas")[0]);
    (window.addEventListener("resize", a.reinit), document.addEventListener("keydown", function (b) {
        if (b.altKey !== !0 && b.ctrlKey !== !0 && b.metaKey !== !0) {
            var c = b.keyCode;
            c = {61: 187, 107: 187, 59: 186}[c] || c;
            var d = {
                82: "#f00",
                186: "#ff0",
                80: "#0f0",
                85: "#0ff",
                67: "#00f",
                65: "#f0f",
                188: "#ccc"
            };
            return b.shiftKey ? (37 === c ? (b.preventDefault(), a.task("left_short")) : 39 === c ? (b.preventDefault(), a.task("right_short")) : 38 === c ? (b.preventDefault(), a.task("run_short")) : 40 === c && (b.preventDefault(), a.task("back_short")), void 0) : (37 === c ? (b.preventDefault(), a.task("left")) : 39 === c ? (b.preventDefault(), a.task("right")) : 38 === c ? (b.preventDefault(), a.task("run")) : 40 === c ? (b.preventDefault(), a.task("back")) : c >= 49 && 57 >= c ? (b.preventDefault(), a.task(c - 48)) : 27 === c ? (b.preventDefault(), a.reset()) : 32 === c ? (b.preventDefault(), a.task("put")) : 187 === c ? (b.preventDefault(), a.task("record")) : d[c] ? (b.preventDefault(), a.task(d[c])) : 69 === c && (b.preventDefault(), a.task("clean")), void 0)
        }
    }, !1), a.reinit(), setInterval(a.tik, 30))
}, !1);
